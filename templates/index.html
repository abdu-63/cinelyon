{% extends 'base.html' %}

{% block head %}

{% endblock %}

{% block body %}

<a href="#headerTop">
    <div class="goTop">
        <p>üçø</p>
    </div>
</a>

<img src="../static/images/background.svg" class="background_svg">

<div id="map"></div>

<div class="planning">

    <div class="search-container">
        <div class="search-row">
            <input type="text" id="search-title" placeholder="üîç Rechercher par titre..."
                class="search-input search-main">
        </div>
        <div class="search-row search-filters">
            <select id="filter-genre" class="search-input">
                <option value="">Tous les genres</option>
                {% for genre in all_genres %}
                <option value="{{ genre|lower }}">{{ genre }}</option>
                {% endfor %}
            </select>
            <select id="filter-director" class="search-input">
                <option value="">Tous les r√©alisateurs</option>
                {% for director in all_directors %}
                <option value="{{ director|lower }}">{{ director }}</option>
                {% endfor %}
            </select>
            <select id="filter-cinema" class="search-input">
                <option value="">Tous les cin√©mas</option>
                <option value="group:pathe">Path√©</option>
                <option value="group:ugc">UGC</option>
                <option value="group:lumiere">Lumi√®re</option>
                <option disabled>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</option>
                {% for cinema in all_cinemas %}
                <option value="{{ cinema|lower }}">{{ cinema }}</option>
                {% endfor %}
            </select>
            <select id="filter-rating" class="search-input">
                <option value="">Toutes les notes</option>
                <option value="9">9+ ‚≠ê</option>
                <option value="8">8+ ‚≠ê</option>
                <option value="7">7+ ‚≠ê</option>
                <option value="6">6+ ‚≠ê</option>
                <option value="5">5+ ‚≠ê</option>
            </select>
            <button id="reset-filters" class="reset-btn">R√©initialiser</button>
            <label class="favorites-toggle">
                <input type="checkbox" id="filter-favorites">
                <svg class="favorites-heart" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path
                        d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" />
                </svg>
                <span class="favorites-label">Favoris</span>
            </label>
        </div>
    </div>

    <div id="films-container">
        {% for film in films %}
        <div class="container_infoFilm film-card" data-title="{{ film.title|lower }}"
            data-genres="{{ film.genres|lower }}" data-director="{{ film.director|lower }}"
            data-rating="{{ film.rating }}" data-year="{{ film.release_year }}"
            data-film-id="{{ film.title|lower|replace(' ', '-') }}"
            data-cinemas="{% for day_data in film.seances_by_day.values() %}{% for cinema in day_data.keys() %}{{ cinema|lower }},{% endfor %}{% endfor %}">
            <img src={{film.affiche}} class="affiche" loading="lazy" decoding="async" width="200" height="288"
                alt="Affiche de {{ film.title }}" />
            <div class="infoFilm">
                <div class="blur-background"></div>
                <div>
                    <h3 class="titreFilm"><a href="{{ film.url }}" target="_blank">{{film.title}}</a> <span
                            class="release_year">({{ film.release_year }})</span>
                        <button class="favorite-btn" title="Ajouter aux favoris">
                            <svg class="favorite-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path
                                    d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" />
                            </svg>
                        </button>
                    </h3>
                    <div class="info-content">
                        <p class="realisateur">R√©alisateur : {{film.director}}</p>
                        <p class="genre">Genre : {{ film.genres }}</p>
                        <p class="duree">Dur√©e : {{film.duree}}</p>
                        <p class="rating">Note : {{ film.rating }}</p>
                    </div>
                    <div style="height: 10px;"></div>
                    <div class="synopsis_container">
                        <p class="synopsis">
                            {{film.synopsis}}
                        </p>
                        <button class="synopsis-toggle" type="button">Lire plus</button>
                    </div>
                </div>
            </div>
        </div>

        <div style="height: 10px;"></div>

        <div class="seances-wrapper">
            {% if show_all %}
            <div class="mini-calendar">
                {% for day_label, cinemas in film.seances_by_day.items() %}
                <button class="mini-cal-btn" type="button" data-day="{{ loop.index0 }}">
                    {{ day_label }}
                </button>
                {% endfor %}
            </div>

            {% for day_label, cinemas in film.seances_by_day.items() %}
            <div class="day-seances" data-day="{{ loop.index0 }}">
                {% for cinename, seances in cinemas.items() %}
                <div class="seance_container">
                    <div class="cinema">
                        <a href="#" class="cinema-link" data-cinema="{{cinename}}" target="_blank" rel="noopener">
                            <p>{{cinename}}</p>
                        </a>
                    </div>
                    <div class="horaires_container">
                        {% for seance in seances %}
                        <div class="horaire-wrapper">
                            {% if seance.ticketing_url %}
                            <a href="{{ seance.ticketing_url }}" target="_blank" rel="noopener" class="horaire-link">
                                <div
                                    class="horaire horaire-{{ seance.lang|lower }}{% if seance.format %} horaire-special{% endif %}">
                                    <span class="lang-badge">{{ seance.lang }}</span>
                                    {% if seance.format %}
                                    <span class="format-badge">{{ seance.format }}</span>
                                    {% endif %}
                                    <p>{{ seance.time }}</p>
                                </div>
                            </a>
                            {% else %}
                            <div
                                class="horaire horaire-{{ seance.lang|lower }}{% if seance.format %} horaire-special{% endif %}">
                                <span class="lang-badge">{{ seance.lang }}</span>
                                {% if seance.format %}
                                <span class="format-badge">{{ seance.format }}</span>
                                {% endif %}
                                <p>{{ seance.time }}</p>
                            </div>
                            {% endif %}
                            <button class="calendar-btn" data-title="{{ film.title }}"
                                data-year="{{ film.release_year }}" data-cinema="{{ cinename }}"
                                data-duree="{{ film.duree }}" data-letterboxd="{{ film.url }}"
                                data-time="{{ seance.time }}" data-lang="{{ seance.lang }}" data-day="{{ day_label }}"
                                data-ticket="{{ seance.ticketing_url|default('', true) }}"
                                title="Ajouter au calendrier">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <rect x="3" y="4" width="18" height="18" rx="2" />
                                    <line x1="3" y1="10" x2="21" y2="10" />
                                    <line x1="8" y1="2" x2="8" y2="6" />
                                    <line x1="16" y1="2" x2="16" y2="6" />
                                </svg>
                            </button>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                <div class="responsive-petite-div"></div>
                {% endfor %}
            </div>
            {% endfor %}
            {% else %}
            {% for day_label, cinemas in film.seances_by_day.items() %}
            {% for cinename, seances in cinemas.items() %}
            <div class="seance_container">
                <div class="cinema">
                    <a href="#" class="cinema-link" data-cinema="{{cinename}}" target="_blank" rel="noopener">
                        <p>{{cinename}}</p>
                    </a>
                </div>
                <div class="horaires_container">
                    {% for seance in seances %}
                    <div class="horaire-wrapper">
                        {% if seance.ticketing_url %}
                        <a href="{{ seance.ticketing_url }}" target="_blank" rel="noopener" class="horaire-link">
                            <div
                                class="horaire horaire-{{ seance.lang|lower }}{% if seance.format %} horaire-special{% endif %}">
                                <span class="lang-badge">{{ seance.lang }}</span>
                                {% if seance.format %}
                                <span class="format-badge">{{ seance.format }}</span>
                                {% endif %}
                                <p>{{ seance.time }}</p>
                            </div>
                        </a>
                        {% else %}
                        <div
                            class="horaire horaire-{{ seance.lang|lower }}{% if seance.format %} horaire-special{% endif %}">
                            <span class="lang-badge">{{ seance.lang }}</span>
                            {% if seance.format %}
                            <span class="format-badge">{{ seance.format }}</span>
                            {% endif %}
                            <p>{{ seance.time }}</p>
                        </div>
                        {% endif %}
                        <button class="calendar-btn" data-title="{{ film.title }}" data-year="{{ film.release_year }}"
                            data-cinema="{{ cinename }}" data-duree="{{ film.duree }}" data-letterboxd="{{ film.url }}"
                            data-time="{{ seance.time }}" data-lang="{{ seance.lang }}" data-day="{{ day_label }}"
                            data-ticket="{{ seance.ticketing_url|default('', true) }}" title="Ajouter au calendrier">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <rect x="3" y="4" width="18" height="18" rx="2" />
                                <line x1="3" y1="10" x2="21" y2="10" />
                                <line x1="8" y1="2" x2="8" y2="6" />
                                <line x1="16" y1="2" x2="16" y2="6" />
                            </svg>
                        </button>
                    </div>
                    {% endfor %}
                </div>
            </div>
            <div class="responsive-petite-div"></div>
            {% endfor %}
            {% endfor %}
            {% endif %}
        </div>
        <div class="responsive-div{% if show_all %} responsive-div-compact{% endif %}"></div>
        {% endfor %}
    </div>

</div>

<script>
    (function () {
        var mapInitialized = false;

        function initMap() {
            var mapContainer = document.getElementById('map');
            if (mapInitialized || typeof mapboxgl === 'undefined' || !mapContainer) return;
            mapInitialized = true;

            mapboxgl.accessToken = '{{ mapbox_token }}';

            var map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/mapbox/streets-v11',
                center: [4.8544994, 45.7620499],
                zoom: 11.5
            });

            map.addControl(new mapboxgl.NavigationControl());

            var locations = [
                { coordinates: [4.9212527, 45.7641958], description: "Path√© Carr√© de Soie" },
                { coordinates: [4.8348411, 45.7587566], description: "Path√© Bellecour" },
                { coordinates: [4.8544482, 45.7620652], description: "UGC Cin√© Cit√© Part-Dieu" },
                { coordinates: [5.0028814, 45.7649601], description: "Cin√© Meyzieu" },
                { coordinates: [4.955623, 45.7687615], description: "Cin√© Toboggan" },
                { coordinates: [4.8181753, 45.7407344], description: "UGC Cin√© Cit√© Confluence" },
                { coordinates: [4.8520202, 45.7845498], description: "UGC Cin√© Cit√© Internationale" },
                { coordinates: [4.8560867, 45.7733587], description: "Path√© Vaise" },
                { coordinates: [4.8767983, 45.7733587], description: "UGC Astoria" },
                { coordinates: [4.7699954, 45.7319408], description: "CGR Brignais" },
                { coordinates: [4.8438138, 45.7320296], description: "Lumi√®re Bellecour" },
                { coordinates: [4.8520202, 45.7320296], description: "Lumi√®re La Fourmi" },
                { coordinates: [4.8673231, 45.7733587], description: "Lumi√®re Terreaux" },
                { coordinates: [4.9027159, 45.7344678], description: "Institut Lumi√®re" },
                { coordinates: [4.8307605, 45.747503], description: "Cin√©ma Comoedia" },
                { coordinates: [4.9153971, 45.78833], description: "Les Amphis" },
                { coordinates: [4.8666958, 45.6969889], description: "Cin√©ma Gerard-Philipe" }
            ];

            locations.forEach(function (location) {
                var el = document.createElement('div');
                el.className = 'custom-marker';

                var googleMapsUrl = "https://www.google.com/maps/search/?api=1&query=" + location.coordinates[1] + "," + location.coordinates[0];
                var appleMapsUrl = "https://maps.apple.com/?q=" + encodeURIComponent(location.description) + "&ll=" + location.coordinates[1] + "," + location.coordinates[0];

                var popupHtml = '<div style="text-align:center;"><strong>' + location.description + '</strong><br>' +
                    '<div style="margin-top:5px; font-size:12px;">' +
                    '<a href="' + googleMapsUrl + '" target="_blank" style="color:#444cf7; text-decoration:none;">Google</a> | ' +
                    '<a href="' + appleMapsUrl + '" target="_blank" style="color:#444cf7; text-decoration:none;">Apple</a>' +
                    '</div></div>';

                var popup = new mapboxgl.Popup({ offset: 25 }).setHTML(popupHtml);

                new mapboxgl.Marker(el)
                    .setLngLat(location.coordinates)
                    .setPopup(popup)
                    .addTo(map);
            });
        }

        function setupLazyMap() {
            var mapContainer = document.getElementById('map');
            if (!mapContainer) return;

            if ('IntersectionObserver' in window) {
                var observer = new IntersectionObserver(function (entries) {
                    entries.forEach(function (entry) {
                        if (entry.isIntersecting) {
                            initMap();
                            observer.disconnect();
                        }
                    });
                }, { rootMargin: '100px' });

                observer.observe(mapContainer);
            } else {
                initMap();
            }
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', setupLazyMap);
        } else {
            setupLazyMap();
        }
    })();

    document.querySelectorAll('.seances-wrapper').forEach(wrapper => {
        const buttons = wrapper.querySelectorAll('.mini-cal-btn');
        const daySeances = wrapper.querySelectorAll('.day-seances');

        buttons.forEach(btn => {
            btn.addEventListener('click', function () {
                const dayIndex = this.dataset.day;
                const isActive = this.classList.contains('active');

                buttons.forEach(b => b.classList.remove('active'));
                daySeances.forEach(d => d.classList.remove('show'));

                if (!isActive) {
                    this.classList.add('active');
                    const targetSeances = wrapper.querySelector(`.day-seances[data-day="${dayIndex}"]`);
                    if (targetSeances) {
                        targetSeances.classList.add('show');
                    }
                }
            });
        });
    });

    document.querySelectorAll('.synopsis-toggle').forEach(btn => {
        const synopsis = btn.previousElementSibling;

        if (synopsis.scrollHeight <= synopsis.clientHeight) {
            btn.style.display = 'none';
        }

        btn.addEventListener('click', function () {
            synopsis.classList.toggle('expanded');
            this.textContent = synopsis.classList.contains('expanded') ? 'Lire moins' : 'Lire plus';
        });
    });

    const FAVORITES_KEY = 'cinelyon_favorites';

    function getFavorites() {
        try {
            const data = localStorage.getItem(FAVORITES_KEY);
            return data ? JSON.parse(data) : [];
        } catch (e) {
            console.error('Erreur lecture favoris:', e);
            return [];
        }
    }

    function saveFavorites(favorites) {
        try {
            localStorage.setItem(FAVORITES_KEY, JSON.stringify(favorites));
        } catch (e) {
            console.error('Erreur sauvegarde favoris:', e);
        }
    }

    function toggleFavorite(filmId) {
        const favorites = getFavorites();
        const index = favorites.indexOf(filmId);
        if (index === -1) {
            favorites.push(filmId);
        } else {
            favorites.splice(index, 1);
        }
        saveFavorites(favorites);
        return index === -1;
    }

    function isFavorite(filmId) {
        return getFavorites().includes(filmId);
    }

    function updateFavoriteButton(btn, isActive) {
        if (isActive) {
            btn.classList.add('active');
            btn.title = 'Retirer des favoris';
        } else {
            btn.classList.remove('active');
            btn.title = 'Ajouter aux favoris';
        }
    }

    document.addEventListener('DOMContentLoaded', function () {
        const films = document.querySelectorAll('.film-card');
        const searchTitle = document.getElementById('search-title');
        const filterGenre = document.getElementById('filter-genre');
        const filterDirector = document.getElementById('filter-director');
        const filterCinema = document.getElementById('filter-cinema');
        const filterRating = document.getElementById('filter-rating');
        const filterFavorites = document.getElementById('filter-favorites');
        const resetBtn = document.getElementById('reset-filters');

        const genres = new Set();
        const directors = new Set();
        const cinemas = new Set();

        films.forEach(film => {
            const filmId = film.dataset.filmId;
            const favoriteBtn = film.querySelector('.favorite-btn');

            updateFavoriteButton(favoriteBtn, isFavorite(filmId));

            favoriteBtn.addEventListener('click', function (e) {
                e.preventDefault();
                e.stopPropagation();
                const isNowFavorite = toggleFavorite(filmId);
                updateFavoriteButton(favoriteBtn, isNowFavorite);

                if (filterFavorites.checked) {
                    filterFilms();
                }
            });
        });

        document.querySelectorAll('.synopsis_container').forEach(container => {
            const synopsis = container.querySelector('.synopsis');
            const toggleBtn = container.querySelector('.synopsis-toggle');
            if (synopsis && toggleBtn) {
                if (synopsis.scrollHeight <= synopsis.clientHeight + 5) {
                    toggleBtn.style.display = 'none';
                    synopsis.classList.add('no-fade');
                }
            }
        });

        function filterFilms() {
            const titleQuery = searchTitle.value.toLowerCase();
            const genreQuery = filterGenre.value.toLowerCase();
            const directorQuery = filterDirector.value.toLowerCase();
            const cinemaQuery = filterCinema.value.toLowerCase();
            const ratingQuery = parseFloat(filterRating.value) || 0;
            const showOnlyFavorites = filterFavorites.checked;

            films.forEach(film => {
                const title = film.dataset.title;
                const genres = film.dataset.genres;
                const director = film.dataset.director;
                const cinemas = film.dataset.cinemas;
                const rating = parseFloat(film.dataset.rating) || 0;
                const filmId = film.dataset.filmId;

                let sibling = film.nextElementSibling;
                const relatedElements = [];
                while (sibling && !sibling.classList.contains('film-card')) {
                    relatedElements.push(sibling);
                    sibling = sibling.nextElementSibling;
                }

                const matchTitle = title.includes(titleQuery);
                const matchGenre = !genreQuery || genres.includes(genreQuery);
                const matchDirector = !directorQuery || director.includes(directorQuery);

                // Gestion des groupes de cin√©mas
                let matchCinema = true;
                if (cinemaQuery) {
                    if (cinemaQuery.startsWith('group:')) {
                        const group = cinemaQuery.split(':')[1];
                        if (group === 'pathe') {
                            matchCinema = cinemas.includes('path√©');
                        } else if (group === 'ugc') {
                            matchCinema = cinemas.includes('ugc');
                        } else if (group === 'lumiere') {
                            matchCinema = cinemas.includes('lumi√®re') || cinemas.includes('institut lumi√®re');
                        }
                    } else {
                        matchCinema = cinemas.includes(cinemaQuery);
                    }
                }
                const matchRating = rating >= ratingQuery;
                const matchFavorites = !showOnlyFavorites || isFavorite(filmId);

                const show = matchTitle && matchGenre && matchDirector && matchCinema && matchRating && matchFavorites;

                film.style.display = show ? '' : 'none';
                relatedElements.forEach(el => el.style.display = show ? '' : 'none');
            });
        }

        searchTitle.addEventListener('input', filterFilms);
        filterGenre.addEventListener('change', filterFilms);
        filterDirector.addEventListener('change', filterFilms);
        filterCinema.addEventListener('change', filterFilms);
        filterRating.addEventListener('change', filterFilms);
        filterFavorites.addEventListener('change', filterFilms);

        resetBtn.addEventListener('click', function () {
            searchTitle.value = '';
            filterGenre.value = '';
            filterDirector.value = '';
            filterCinema.value = '';
            filterRating.value = '';
            filterFavorites.checked = false;
            filterFilms();
        });
    });

    const cinemaUrls = {
        "Path√© Carr√© de Soie": "https://www.pathe.fr/cinemas/cinema-pathe-carre-de-soie",
        "Path√© Bellecour": "https://www.pathe.fr/cinemas/cinema-pathe-bellecour",
        "Path√© Vaise": "https://www.pathe.fr/cinemas/cinema-pathe-vaise",
        "UGC Part-Dieu": "https://www.ugc.fr/cinema-ugc-cine-cite-part-dieu.html",
        "UGC Confluence": "https://www.ugc.fr/cinema-ugc-cine-cite-confluence.html",
        "UGC Internationale": "https://www.ugc.fr/cinema-ugc-cine-cite-internationale-lyon.html",
        "UGC Astoria": "https://www.ugc.fr/cinema-ugc-astoria.html",
        "CGR Brignais": "https://www.cgrcinemas.fr/films-a-l-affiche/",
        "Cin√© Meyzieu": "https://cinemeyzieu.fr/",
        "Cin√© Toboggan": "https://www.letoboggan.com/cinema/",
        "Lumi√®re Bellecour": "https://www.cinemas-lumiere.com/programmation/bellecour.html",
        "Lumi√®re La Fourmi": "https://www.cinemas-lumiere.com/programmation/fourmi.html",
        "Lumi√®re Terreaux": "https://www.cinemas-lumiere.com/programmation/terreaux.html",
        "Institut Lumi√®re": "https://www.institut-lumiere.org/"
    };

    document.querySelectorAll('.cinema-link').forEach(link => {
        const cinemaName = link.dataset.cinema;
        const url = cinemaUrls[cinemaName];
        if (url) {
            link.href = url;
        } else {
            // Si pas d'URL connue, recherche Google
            link.href = `https://www.google.com/search?q=${encodeURIComponent(cinemaName + ' Lyon')}`;
        }
    });

    // Calendar button functionality
    const cinemaAddresses = {
        "Path√© Carr√© de Soie": "Place Jacques Monod, Carr√© de Soie, 69120 Vaulx-en-Velin",
        "Path√© Bellecour": "79 Rue de la R√©publique, 69002 Lyon",
        "Path√© Vaise": "33 Rue des Docks, 69009 Lyon",
        "UGC Part-Dieu": "Centre Commercial Part-Dieu, 69003 Lyon",
        "UGC Confluence": "112 Cours Charlemagne, 69002 Lyon",
        "UGC Internationale": "Cit√© Internationale, 80 Quai Charles de Gaulle, 69006 Lyon",
        "UGC Astoria": "31 Rue de la R√©publique, 69002 Lyon",
        "CGR Brignais": "330 Route de Givors, 69530 Brignais",
        "Cin√© Meyzieu": "24 Rue Louis Saulnier, 69330 Meyzieu",
        "Cin√© Toboggan": "14 Avenue Jean Mac√©, 69150 D√©cines-Charpieu",
        "Lumi√®re Bellecour": "12 Rue de la Barre, 69002 Lyon",
        "Lumi√®re La Fourmi": "8 Grande Rue de la Guilloti√®re, 69007 Lyon",
        "Lumi√®re Terreaux": "40 Rue du Pr√©sident √âdouard Herriot, 69001 Lyon",
        "Institut Lumi√®re": "25 Rue du Premier-Film, 69008 Lyon",
        "Cin√©ma Comoedia": "13 Avenue Berthelot, 69007 Lyon",
        "Les Amphis": "10 All√©e Pierre de Coubertin, 69100 Villeurbanne",
        "Cin√©ma Gerard-Philipe": "12 Rue √âmile Zola, 69200 V√©nissieux"
    };

    function parseDuration(dureeStr) {
        let hours = 0, minutes = 0;
        const hourMatch = dureeStr.match(/(\d+)\s*h/);
        const minMatch = dureeStr.match(/(\d+)\s*min/);
        if (hourMatch) hours = parseInt(hourMatch[1]);
        if (minMatch) minutes = parseInt(minMatch[1]);
        return { hours, minutes };
    }

    function parseDayLabel(dayLabel) {
        // Format: "Dim 18 janv" or "Lun 13 Janv"
        const dayAbbrevMap = {
            'lun': 1, 'mar': 2, 'mer': 3, 'jeu': 4,
            'ven': 5, 'sam': 6, 'dim': 0
        };

        const monthAbbrevMap = {
            'janv': 0, 'f√©vr': 1, 'mars': 2, 'avr': 3,
            'mai': 4, 'juin': 5, 'juil': 6, 'ao√ªt': 7,
            'sept': 8, 'oct': 9, 'nov': 10, 'd√©c': 11
        };

        const parts = dayLabel.toLowerCase().split(' ');
        const dayNum = parseInt(parts[1]);
        const monthAbbrev = parts[2];

        const today = new Date();
        let year = today.getFullYear();
        const monthNum = monthAbbrevMap[monthAbbrev];

        // If the month is before current month, it's next year
        if (monthNum !== undefined && monthNum < today.getMonth()) {
            year++;
        }

        const targetDate = new Date(year, monthNum !== undefined ? monthNum : today.getMonth(), dayNum);
        return targetDate;
    }

    function formatICSDate(date) {
        const pad = n => n.toString().padStart(2, '0');
        return `${date.getFullYear()}${pad(date.getMonth() + 1)}${pad(date.getDate())}T${pad(date.getHours())}${pad(date.getMinutes())}00`;
    }

    function formatGoogleDate(date) {
        const pad = n => n.toString().padStart(2, '0');
        return `${date.getFullYear()}${pad(date.getMonth() + 1)}${pad(date.getDate())}T${pad(date.getHours())}${pad(date.getMinutes())}00`;
    }

    function getEventData(btn) {
        const title = btn.dataset.title;
        const year = btn.dataset.year;
        const cinema = btn.dataset.cinema;
        const duree = btn.dataset.duree;
        const letterboxd = btn.dataset.letterboxd;
        const time = btn.dataset.time;
        const lang = btn.dataset.lang;
        const dayLabel = btn.dataset.day;
        const ticketUrl = btn.dataset.ticket;

        const movieTitle = `${title} (${year})`;
        const location = cinemaAddresses[cinema] || `${cinema}, Lyon`;
        const duration = parseDuration(duree);

        const eventDate = parseDayLabel(dayLabel);
        const [hours, minutes] = time.split(':').map(Number);
        eventDate.setHours(hours, minutes, 0, 0);

        const endDate = new Date(eventDate);
        endDate.setHours(endDate.getHours() + duration.hours);
        endDate.setMinutes(endDate.getMinutes() + duration.minutes);

        let description = `Film: ${title} (${year})\nLangue: ${lang}\nDur√©e: ${duree}`;
        if (ticketUrl) {
            description += `\n\nR√©server: ${ticketUrl}`;
        }
        description += `\n\nLetterboxd: ${letterboxd}`;

        return { movieTitle, location, eventDate, endDate, description, letterboxd, title, time };
    }

    function escapeICS(str) {
        // Escape special characters for ICS format
        return str
            .replace(/\\/g, '\\\\')
            .replace(/;/g, '\\;')
            .replace(/,/g, '\\,')
            .replace(/\n/g, '\\n');
    }

    function generateICS(data) {
        const uid = `cinelyon-${Date.now()}-${Math.random().toString(36).substr(2, 9)}@cinelyon.vercel.app`;
        const now = new Date();
        const descEscaped = escapeICS(data.description);
        const locationEscaped = escapeICS(data.location);
        const titleEscaped = escapeICS(data.movieTitle);

        return `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//CineLyon//Calendar//FR
CALSCALE:GREGORIAN
METHOD:PUBLISH
BEGIN:VEVENT
UID:${uid}
DTSTAMP:${formatICSDate(now)}
DTSTART:${formatICSDate(data.eventDate)}
DTEND:${formatICSDate(data.endDate)}
SUMMARY:${titleEscaped}
LOCATION:${locationEscaped}
DESCRIPTION:${descEscaped}
URL:${data.letterboxd}
END:VEVENT
END:VCALENDAR`;
    }

    function generateGoogleCalendarUrl(data) {
        const params = new URLSearchParams({
            action: 'TEMPLATE',
            text: data.movieTitle,
            dates: `${formatGoogleDate(data.eventDate)}/${formatGoogleDate(data.endDate)}`,
            details: data.description,
            location: data.location,
            sprop: `website:${data.letterboxd}`
        });
        return `https://calendar.google.com/calendar/render?${params.toString()}`;
    }

    function downloadICS(icsContent, filename) {
        const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(link.href);
    }

    // Create dropdown menu
    const calendarMenu = document.createElement('div');
    calendarMenu.className = 'calendar-menu';
    calendarMenu.innerHTML = `
        <button class="calendar-menu-option" data-type="apple">
            <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16">
                <path d="M18.71 19.5c-.83 1.24-1.71 2.45-3.05 2.47-1.34.03-1.77-.79-3.29-.79-1.53 0-2 .77-3.27.82-1.31.05-2.3-1.32-3.14-2.53C4.25 17 2.94 12.45 4.7 9.39c.87-1.52 2.43-2.48 4.12-2.51 1.28-.02 2.5.87 3.29.87.78 0 2.26-1.07 3.81-.91.65.03 2.47.26 3.64 1.98-.09.06-2.17 1.28-2.15 3.81.03 3.02 2.65 4.03 2.68 4.04-.03.07-.42 1.44-1.38 2.83M13 3.5c.73-.83 1.94-1.46 2.94-1.5.13 1.17-.34 2.35-1.04 3.19-.69.85-1.83 1.51-2.95 1.42-.15-1.15.41-2.35 1.05-3.11z"/>
            </svg>
            Apple Calendar
        </button>
        <button class="calendar-menu-option" data-type="google">
            <svg viewBox="0 0 24 24" width="16" height="16">
                <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
            </svg>
            Google Calendar
        </button>
    `;
    document.body.appendChild(calendarMenu);

    let activeCalendarBtn = null;

    function closeCalendarMenu() {
        calendarMenu.classList.remove('show');
        activeCalendarBtn = null;
    }

    document.addEventListener('click', function (e) {
        if (!e.target.closest('.calendar-btn') && !e.target.closest('.calendar-menu')) {
            closeCalendarMenu();
        }
    });

    calendarMenu.querySelectorAll('.calendar-menu-option').forEach(option => {
        option.addEventListener('click', function () {
            if (!activeCalendarBtn) return;

            const type = this.dataset.type;
            const data = getEventData(activeCalendarBtn);

            if (type === 'apple') {
                const icsContent = generateICS(data);
                const filename = `${data.title.replace(/[^a-z0-9]/gi, '_')}_${data.time.replace(':', 'h')}.ics`;
                downloadICS(icsContent, filename);
            } else if (type === 'google') {
                const url = generateGoogleCalendarUrl(data);
                window.open(url, '_blank');
            }

            activeCalendarBtn.classList.add('added');
            setTimeout(() => {
                activeCalendarBtn.classList.remove('added');
            }, 2000);

            closeCalendarMenu();
        });
    });

    document.querySelectorAll('.calendar-btn').forEach(btn => {
        btn.addEventListener('click', function (e) {
            e.preventDefault();
            e.stopPropagation();

            const rect = this.getBoundingClientRect();
            calendarMenu.style.top = `${rect.bottom + window.scrollY + 5}px`;
            calendarMenu.style.left = `${rect.left + window.scrollX}px`;

            activeCalendarBtn = this;
            calendarMenu.classList.add('show');
        });
    });
</script>

{% endblock %}