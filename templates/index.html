{% extends 'base.html' %}

{% block head %}

{% endblock %}

{% block body %}

<a href="#headerTop">
    <div class="goTop">
        <p>üçø</p>
    </div>
</a>

<img src="../static/images/background.svg" class="background_svg">


<div id="map"></div>

<div class="planning">


    <div class="search-container">
        <div class="search-row">
            <input type="text" id="search-title" placeholder="üîç Rechercher par titre..."
                class="search-input search-main">
        </div>
        <div class="search-row search-filters">
            <select id="filter-genre" class="search-input">
                <option value="">Tous les genres</option>
            </select>
            <select id="filter-director" class="search-input">
                <option value="">Tous les r√©alisateurs</option>
            </select>
            <select id="filter-cinema" class="search-input">
                <option value="">Tous les cin√©mas</option>
            </select>
            <select id="filter-rating" class="search-input">
                <option value="">Toutes les notes</option>
                <option value="9">9+ ‚≠ê</option>
                <option value="8">8+ ‚≠ê</option>
                <option value="7">7+ ‚≠ê</option>
                <option value="6">6+ ‚≠ê</option>
                <option value="5">5+ ‚≠ê</option>
            </select>
            <button id="reset-filters" class="reset-btn">R√©initialiser</button>
        </div>
    </div>

    <div id="films-container">
        {% for film in films %}
        <div class="container_infoFilm film-card" data-title="{{ film.title|lower }}"
            data-genres="{{ film.genres|lower }}" data-director="{{ film.director|lower }}"
            data-rating="{{ film.rating }}" data-year="{{ film.release_year }}"
            data-cinemas="{% for day_data in film.seances_by_day.values() %}{% for cinema in day_data.keys() %}{{ cinema|lower }},{% endfor %}{% endfor %}">
            <img src={{film.affiche}} class="affiche" />
            <div class="infoFilm">
                <div class="blur-background"></div>
                <div>
                    <h3 class="titreFilm"><a href="{{ film.url }}" target="_blank">{{film.title}}</a> <span
                            class="release_year">({{ film.release_year }})</span></h3>
                    <div class="info-content">
                        <p class="realisateur">R√©alisateur : {{film.director}}</p>
                        <p class="genre">Genre : {{ film.genres }}</p>
                        <p class="duree">Dur√©e : {{film.duree}}</p>
                        <p class="rating">Note : {{ film.rating }}</p>
                    </div>
                    <div style="height: 30px;"></div>
                    <div class="synopsis_container">
                        <p class="synopsis">
                            {{film.synopsis}}
                        </p>
                        <button class="synopsis-toggle" type="button">Lire plus</button>
                    </div>
                </div>
            </div>
        </div>

        <div style="height: 10px;"></div>

        <div class="seances-wrapper">
            {% if show_all %}
            <div class="mini-calendar">
                {% for day_label, cinemas in film.seances_by_day.items() %}
                <button class="mini-cal-btn" type="button" data-day="{{ loop.index0 }}">
                    {{ day_label }}
                </button>
                {% endfor %}
            </div>

            {% for day_label, cinemas in film.seances_by_day.items() %}
            <div class="day-seances" data-day="{{ loop.index0 }}">
                {% for cinename, seances in cinemas.items() %}
                <div class="seance_container">
                    <div class="cinema">
                        <a href="#" class="cinema-link" data-cinema="{{cinename}}" target="_blank" rel="noopener">
                            <p>{{cinename}}</p>
                        </a>
                    </div>
                    <div class="horaires_container">
                        {% for seance in seances %}
                        {% if seance.ticketing_url %}
                        <a href="{{ seance.ticketing_url }}" target="_blank" rel="noopener" class="horaire-link">
                            <div
                                class="horaire horaire-{{ seance.lang|lower }}{% if seance.format %} horaire-special{% endif %}">
                                <span class="lang-badge">{{ seance.lang }}</span>
                                {% if seance.format %}
                                <span class="format-badge">{{ seance.format }}</span>
                                {% endif %}
                                <p>{{ seance.time }}</p>
                            </div>
                        </a>
                        {% else %}
                        <div
                            class="horaire horaire-{{ seance.lang|lower }}{% if seance.format %} horaire-special{% endif %}">
                            <span class="lang-badge">{{ seance.lang }}</span>
                            {% if seance.format %}
                            <span class="format-badge">{{ seance.format }}</span>
                            {% endif %}
                            <p>{{ seance.time }}</p>
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>
                </div>
                <div class="responsive-petite-div"></div>
                {% endfor %}
            </div>
            {% endfor %}
            {% else %}
            {% for day_label, cinemas in film.seances_by_day.items() %}
            {% for cinename, seances in cinemas.items() %}
            <div class="seance_container">
                <div class="cinema">
                    <a href="#" class="cinema-link" data-cinema="{{cinename}}" target="_blank" rel="noopener">
                        <p>{{cinename}}</p>
                    </a>
                </div>
                <div class="horaires_container">
                    {% for seance in seances %}
                    {% if seance.ticketing_url %}
                    <a href="{{ seance.ticketing_url }}" target="_blank" rel="noopener" class="horaire-link">
                        <div
                            class="horaire horaire-{{ seance.lang|lower }}{% if seance.format %} horaire-special{% endif %}">
                            <span class="lang-badge">{{ seance.lang }}</span>
                            {% if seance.format %}
                            <span class="format-badge">{{ seance.format }}</span>
                            {% endif %}
                            <p>{{ seance.time }}</p>
                        </div>
                    </a>
                    {% else %}
                    <div
                        class="horaire horaire-{{ seance.lang|lower }}{% if seance.format %} horaire-special{% endif %}">
                        <span class="lang-badge">{{ seance.lang }}</span>
                        {% if seance.format %}
                        <span class="format-badge">{{ seance.format }}</span>
                        {% endif %}
                        <p>{{ seance.time }}</p>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
            </div>
            <div class="responsive-petite-div"></div>
            {% endfor %}
            {% endfor %}
            {% endif %}
        </div>
        <div class="responsive-div{% if show_all %} responsive-div-compact{% endif %}"></div>
        {% endfor %}
    </div>

</div>



<script>
    mapboxgl.accessToken = '{{ mapbox_token }}';

    var map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/streets-v11',
        center: [4.888243, 45.758384],
        zoom: 11.7
    });

    map.addControl(new mapboxgl.NavigationControl());

    var locations = [
        { coordinates: [4.9212527, 45.7641958], description: "Path√© Carr√© de Soie" },
        { coordinates: [4.8348411, 45.7587566], description: "Path√© Bellecour" },
        { coordinates: [4.8544994, 45.7620499], description: "UGC Cin√© Cit√© Part-Dieu" },
        { coordinates: [5.0028814, 45.7649601], description: "Cin√© Meyzieu" },
        { coordinates: [4.955623, 45.7687615], description: "Cin√© Toboggan" },
        { coordinates: [4.8181753, 45.7407344], description: "UGC Cin√© Cit√© Confluence" },
        { coordinates: [4.8520202, 45.7845498], description: "UGC Cin√© Cit√© Internationale" },
        { coordinates: [4.8560867, 45.7733587], description: "Path√© Vaise" },
        { coordinates: [4.8767983, 45.7733587], description: "UGC Astoria" },
        { coordinates: [4.7699954, 45.7319408], description: "CGR Brignais" },
        { coordinates: [4.8438138, 45.7320296], description: "Lumi√®re Bellecour" },
        { coordinates: [4.8520202, 45.7320296], description: "Lumi√®re La Fourmi" },
        { coordinates: [4.8673231, 45.7733587], description: "Lumi√®re Terreaux" },
        { coordinates: [4.9027159, 45.7344678], description: "Institut Lumi√®re" }
    ];

    locations.forEach(function (location) {
        var el = document.createElement('div');
        el.className = 'custom-marker';

        var googleMapsUrl = "https://www.google.com/maps/search/?api=1&query=" + location.coordinates[1] + "," + location.coordinates[0];
        var appleMapsUrl = "https://maps.apple.com/?q=" + encodeURIComponent(location.description) + "&ll=" + location.coordinates[1] + "," + location.coordinates[0];

        var popupHtml = '<div style="text-align:center;"><strong>' + location.description + '</strong><br>' +
            '<div style="margin-top:5px; font-size:12px;">' +
            '<a href="' + googleMapsUrl + '" target="_blank" style="color:#444cf7; text-decoration:none;">Google</a> | ' +
            '<a href="' + appleMapsUrl + '" target="_blank" style="color:#444cf7; text-decoration:none;">Apple</a>' +
            '</div></div>';

        var popup = new mapboxgl.Popup({ offset: 25 }).setHTML(popupHtml);

        new mapboxgl.Marker(el)
            .setLngLat(location.coordinates)
            .setPopup(popup)
            .addTo(map);
    });

    document.querySelectorAll('.seances-wrapper').forEach(wrapper => {
        const buttons = wrapper.querySelectorAll('.mini-cal-btn');
        const daySeances = wrapper.querySelectorAll('.day-seances');

        buttons.forEach(btn => {
            btn.addEventListener('click', function () {
                const dayIndex = this.dataset.day;

                // D√©sactiver tous les boutons et cacher toutes les s√©ances
                buttons.forEach(b => b.classList.remove('active'));
                daySeances.forEach(d => d.classList.remove('show'));

                // Activer le bouton cliqu√© et afficher ses s√©ances
                this.classList.add('active');
                const targetSeances = wrapper.querySelector(`.day-seances[data-day="${dayIndex}"]`);
                if (targetSeances) {
                    targetSeances.classList.add('show');
                }
            });
        });
    });

    document.querySelectorAll('.synopsis-toggle').forEach(btn => {
        btn.addEventListener('click', function () {
            const synopsis = this.previousElementSibling;
            synopsis.classList.toggle('expanded');
            this.textContent = synopsis.classList.contains('expanded') ? 'Lire moins' : 'Lire plus';
        });
    });

    document.addEventListener('DOMContentLoaded', function () {
        const films = document.querySelectorAll('.film-card');
        const searchTitle = document.getElementById('search-title');
        const filterGenre = document.getElementById('filter-genre');
        const filterDirector = document.getElementById('filter-director');
        const filterCinema = document.getElementById('filter-cinema');
        const filterRating = document.getElementById('filter-rating');
        const resetBtn = document.getElementById('reset-filters');

        const genres = new Set();
        const directors = new Set();
        const cinemas = new Set();

        films.forEach(film => {
            film.dataset.genres.split(',').forEach(g => {
                g = g.trim();
                if (g) genres.add(g);
            });
            if (film.dataset.director) directors.add(film.dataset.director);
            film.dataset.cinemas.split(',').forEach(c => {
                c = c.trim();
                if (c) cinemas.add(c);
            });
        });

        [...genres].sort().forEach(g => {
            const opt = document.createElement('option');
            opt.value = g;
            opt.textContent = g.charAt(0).toUpperCase() + g.slice(1);
            filterGenre.appendChild(opt);
        });

        [...directors].sort().forEach(d => {
            const opt = document.createElement('option');
            opt.value = d;
            opt.textContent = d.charAt(0).toUpperCase() + d.slice(1);
            filterDirector.appendChild(opt);
        });

        [...cinemas].sort().forEach(c => {
            const opt = document.createElement('option');
            opt.value = c;
            opt.textContent = c.charAt(0).toUpperCase() + c.slice(1);
            filterCinema.appendChild(opt);
        });

        function filterFilms() {
            const titleQuery = searchTitle.value.toLowerCase();
            const genreQuery = filterGenre.value.toLowerCase();
            const directorQuery = filterDirector.value.toLowerCase();
            const cinemaQuery = filterCinema.value.toLowerCase();
            const ratingQuery = parseFloat(filterRating.value) || 0;

            films.forEach(film => {
                const title = film.dataset.title;
                const genres = film.dataset.genres;
                const director = film.dataset.director;
                const cinemas = film.dataset.cinemas;
                const rating = parseFloat(film.dataset.rating) || 0;

                // Trouver les s√©ances associ√©es √† ce film
                let sibling = film.nextElementSibling;
                const relatedElements = [];
                while (sibling && !sibling.classList.contains('film-card')) {
                    relatedElements.push(sibling);
                    sibling = sibling.nextElementSibling;
                }

                const matchTitle = title.includes(titleQuery);
                const matchGenre = !genreQuery || genres.includes(genreQuery);
                const matchDirector = !directorQuery || director.includes(directorQuery);
                const matchCinema = !cinemaQuery || cinemas.includes(cinemaQuery);
                const matchRating = rating >= ratingQuery;

                const show = matchTitle && matchGenre && matchDirector && matchCinema && matchRating;

                film.style.display = show ? '' : 'none';
                relatedElements.forEach(el => el.style.display = show ? '' : 'none');
            });
        }

        searchTitle.addEventListener('input', filterFilms);
        filterGenre.addEventListener('change', filterFilms);
        filterDirector.addEventListener('change', filterFilms);
        filterCinema.addEventListener('change', filterFilms);
        filterRating.addEventListener('change', filterFilms);

        resetBtn.addEventListener('click', function () {
            searchTitle.value = '';
            filterGenre.value = '';
            filterDirector.value = '';
            filterCinema.value = '';
            filterRating.value = '';
            filterFilms();
        });
    });

    const cinemaUrls = {
        "Path√© Carr√© de Soie": "https://www.pathe.fr/cinemas/cinema-pathe-carre-de-soie",
        "Path√© Bellecour": "https://www.pathe.fr/cinemas/cinema-pathe-bellecour",
        "Path√© Vaise": "https://www.pathe.fr/cinemas/cinema-pathe-vaise",
        "UGC Part-Dieu": "https://www.ugc.fr/cinema-ugc-cine-cite-part-dieu.html",
        "UGC Confluence": "https://www.ugc.fr/cinema-ugc-cine-cite-confluence.html",
        "UGC Internationale": "https://www.ugc.fr/cinema-ugc-cine-cite-internationale-lyon.html",
        "UGC Astoria": "https://www.ugc.fr/cinema-ugc-astoria.html",
        "CGR Brignais": "https://www.cgrcinemas.fr/films-a-l-affiche/",
        "Cin√© Meyzieu": "https://cinemeyzieu.fr/",
        "Cin√© Toboggan": "https://www.letoboggan.com/cinema/",
        "Lumi√®re Bellecour": "https://www.cinemas-lumiere.com/programmation/bellecour.html",
        "Lumi√®re La Fourmi": "https://www.cinemas-lumiere.com/programmation/fourmi.html",
        "Lumi√®re Terreaux": "https://www.cinemas-lumiere.com/programmation/terreaux.html",
        "Institut Lumi√®re": "https://www.institut-lumiere.org/"
    };

    document.querySelectorAll('.cinema-link').forEach(link => {
        const cinemaName = link.dataset.cinema;
        const url = cinemaUrls[cinemaName];
        if (url) {
            link.href = url;
        } else {
            // Si pas d'URL connue, recherche Google
            link.href = `https://www.google.com/search?q=${encodeURIComponent(cinemaName + ' Lyon')}`;
        }
    });
</script>


{% endblock %}